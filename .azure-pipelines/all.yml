trigger:
  batch: false
  branches:
    include:
    - master

pr:
  branches:
    include:
    - master

resources:
  containers:
  - container: datadog-agent
    image: datadog/agent:7
    options: --health-cmd="exit 0" --health-interval=1s
    ports:
    - 8125:8125
    - 8126:8126/tcp
    env:
      DD_API_KEY: $(ddAPIKey)
      DD_APM_ENABLED: "true"
      DD_APM_NON_LOCAL_TRAFFIC: "true"
      DD_LOGS_ENABLED: "true"
      DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL: "true"
      DD_AC_EXCLUDE: "name:datadog-agent"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro

jobs:
- job: UnitTests
  pool:
    vmImage: "Ubuntu-16.04"
  container:
    image: ruby:$(RUBY_VERSION)
    options: >-
      -l com.datadoghq.ad.logs="[{\"source\": \"Azure Pipeline\", \"service\": \"dogapi-rb\"}]"
  services:
    datadog-agent: datadog-agent
  strategy:
    matrix:
      Rb19:
        RUBY_VERSION: '1.9.3'
        TASK: spec
        PRE_INSTALL: 'gem install bundler -v 1.0.10; mv Gemfile_1.9 Gemfile'
      Rb24:
        RUBY_VERSION: '2.4'
        TASK: spec
        PRE_INSTALL: ''
      Rb25:
        RUBY_VERSION: '2.5'
        TASK: spec
        PRE_INSTALL: ''
      Rb26:
        RUBY_VERSION: '2.6'
        TASK: spec
        PRE_INSTALL: ''
      Rb27:
        RUBY_VERSION: '2.7'
        TASK: spec
        PRE_INSTALL: ''
      Lint:
        RUBY_VERSION: '2.6'
        TASK: rubocop
        PRE_INSTALL: ''
  steps:
    - script: |
        $(PRE_INSTALL)
        bundle install
      displayName: 'bundle install'
      env:
        GEM_HOME: '~/.gem'
        BUNDLE_RETRY: '3'
        BUNDLE_JOBS: '4'
    - script: bundle exec rake $(TASK)
      displayName: Run $(TASK) via bundle
      env:
        GEM_HOME: '~/.gem'
        DD_AGENT_HOST: datadog-agent
        DD_ENV: ci
        DD_SERVICE: dogapi-rb
        DD_TAGS: "team:integration-tools-and-libraries,runtime:ruby-$(RUBY_VERSION),ci.job.name:$(System.JobName),matrix:$(TASK)"
        DD_TRACE_ANALYTICS_ENABLED: "true"
